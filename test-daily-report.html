<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æŠ¥åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #3182ce;
        }
        .log {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .task-item {
            background: #f8f9fa;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            border-left: 4px solid #48bb78;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ“… æ—¥æŠ¥åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. æµ‹è¯•ä»»åŠ¡ç­›é€‰</h2>
            <p>æ¨¡æ‹Ÿä¸€äº›å·²å®Œæˆçš„ä»»åŠ¡ï¼Œæµ‹è¯•æ—¥æœŸç­›é€‰åŠŸèƒ½</p>
            <button class="btn" onclick="testTaskFiltering()">æµ‹è¯•ä»»åŠ¡ç­›é€‰</button>
            <div id="filterLog" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>2. æµ‹è¯•è±†åŒ…APIä»£ç†</h2>
            <p>æµ‹è¯•é€šè¿‡ä»£ç†æœåŠ¡å™¨è°ƒç”¨è±†åŒ…API</p>
            <button class="btn" onclick="testDoubaoAPI()">æµ‹è¯•è±†åŒ…API</button>
            <div id="apiLog" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>3. å®Œæ•´æ—¥æŠ¥ç”Ÿæˆæµ‹è¯•</h2>
            <p>ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå®Œæ•´æ—¥æŠ¥</p>
            <input type="date" id="testDate" value="2025-07-11">
            <button class="btn" onclick="testFullDailyReport()">ç”Ÿæˆæµ‹è¯•æ—¥æŠ¥</button>
            <div id="reportLog" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>4. æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®</h2>
            <div id="mockTasks"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®
        const mockTasks = [
            {
                id: 'task1',
                title: 'å®Œæˆé¡¹ç›®éœ€æ±‚åˆ†æ',
                project: 'æµ‹è¯•é¡¹ç›®',
                assignee: 'å¼ ä¸‰',
                completed: true,
                completedTime: new Date('2025-07-11 09:30:00').getTime(),
                createTime: new Date('2025-07-10 14:00:00').getTime()
            },
            {
                id: 'task2', 
                title: 'ç¼–å†™æŠ€æœ¯æ–‡æ¡£',
                project: 'æµ‹è¯•é¡¹ç›®',
                assignee: 'æå››',
                completed: true,
                completedTime: new Date('2025-07-11 15:45:00').getTime(),
                createTime: new Date('2025-07-10 16:00:00').getTime()
            },
            {
                id: 'task3',
                title: 'ä»£ç å®¡æŸ¥',
                project: 'æ–°ç–†ç”µç½‘ä¸€æœŸ',
                assignee: 'ç‹äº”',
                completed: true,
                completedTime: new Date('2025-07-10 11:20:00').getTime(),
                createTime: new Date('2025-07-09 10:00:00').getTime()
            },
            {
                id: 'task4',
                title: 'æœªå®Œæˆçš„ä»»åŠ¡',
                project: 'æµ‹è¯•é¡¹ç›®',
                assignee: 'èµµå…­',
                completed: false,
                createTime: new Date('2025-07-11 08:00:00').getTime()
            }
        ];

        // æ˜¾ç¤ºæ¨¡æ‹Ÿä»»åŠ¡
        function displayMockTasks() {
            const container = document.getElementById('mockTasks');
            container.innerHTML = mockTasks.map(task => `
                <div class="task-item">
                    <strong>${task.title}</strong><br>
                    é¡¹ç›®: ${task.project} | è´Ÿè´£äºº: ${task.assignee}<br>
                    çŠ¶æ€: ${task.completed ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}<br>
                    ${task.completedTime ? `å®Œæˆæ—¶é—´: ${new Date(task.completedTime).toLocaleString()}` : ''}
                </div>
            `).join('');
        }

        // æµ‹è¯•ä»»åŠ¡ç­›é€‰
        function testTaskFiltering() {
            const log = document.getElementById('filterLog');
            log.style.display = 'block';
            log.textContent = '';

            function logMessage(msg) {
                log.textContent += msg + '\n';
            }

            logMessage('ğŸ” å¼€å§‹æµ‹è¯•ä»»åŠ¡ç­›é€‰...');
            
            // æ¨¡æ‹Ÿç­›é€‰2025-07-11çš„ä»»åŠ¡
            const targetDate = '2025-07-11';
            const date = new Date(targetDate);
            const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const endOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1);
            
            logMessage(`ç­›é€‰æ—¥æœŸèŒƒå›´: ${startOfDay.toLocaleString()} - ${endOfDay.toLocaleString()}`);
            
            const filteredTasks = mockTasks.filter(task => {
                if (!task.completed) {
                    return false;
                }
                
                let completedTime = task.completedTime || task.completeTime || task.å®Œæˆæ—¶é—´;
                if (!completedTime && task.createTime) {
                    logMessage(`âš ï¸ ä»»åŠ¡ "${task.title}" æ²¡æœ‰å®Œæˆæ—¶é—´ï¼Œä½¿ç”¨åˆ›å»ºæ—¶é—´ä½œä¸ºå¤‡é€‰`);
                    completedTime = task.createTime;
                }
                
                if (!completedTime) {
                    logMessage(`âŒ ä»»åŠ¡ "${task.title}" æ²¡æœ‰æ—¶é—´ä¿¡æ¯ï¼Œè·³è¿‡`);
                    return false;
                }
                
                const completedDate = new Date(completedTime);
                const isInRange = completedDate >= startOfDay && completedDate < endOfDay;
                
                if (isInRange) {
                    logMessage(`âœ… æ‰¾åˆ°åŒ¹é…ä»»åŠ¡: "${task.title}" å®Œæˆäº ${completedDate.toLocaleString()}`);
                }
                
                return isInRange;
            });
            
            logMessage(`\nğŸ“‹ ç­›é€‰ç»“æœ: æ‰¾åˆ° ${filteredTasks.length} ä¸ªåœ¨ ${targetDate} å®Œæˆçš„ä»»åŠ¡`);
            filteredTasks.forEach(task => {
                logMessage(`  - ${task.title} (${task.project})`);
            });
        }

        // æµ‹è¯•è±†åŒ…API
        async function testDoubaoAPI() {
            const log = document.getElementById('apiLog');
            log.style.display = 'block';
            log.textContent = '';

            function logMessage(msg) {
                log.textContent += msg + '\n';
            }

            logMessage('ğŸ¤– å¼€å§‹æµ‹è¯•è±†åŒ…API...');
            
            try {
                // æ£€æµ‹ç¯å¢ƒ
                const proxyUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? 'http://localhost:3002' 
                    : 'https://tasklit.netlify.app/.netlify/functions';
                
                logMessage(`ä½¿ç”¨ä»£ç†URL: ${proxyUrl}`);
                
                const testMessages = [
                    {
                        role: 'user',
                        content: 'è¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼Œä¸è¶…è¿‡50å­—ã€‚'
                    }
                ];
                
                logMessage('å‘é€æµ‹è¯•è¯·æ±‚...');
                
                const response = await fetch(`${proxyUrl}/doubao-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: testMessages
                    })
                });
                
                logMessage(`å“åº”çŠ¶æ€: ${response.status}`);
                
                const data = await response.json();
                logMessage(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    logMessage('âœ… è±†åŒ…APIæµ‹è¯•æˆåŠŸ!');
                } else {
                    logMessage(`âŒ è±†åŒ…APIæµ‹è¯•å¤±è´¥: ${data.error}`);
                }
                
            } catch (error) {
                logMessage(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        // æµ‹è¯•å®Œæ•´æ—¥æŠ¥ç”Ÿæˆ
        async function testFullDailyReport() {
            const log = document.getElementById('reportLog');
            log.style.display = 'block';
            log.textContent = '';

            function logMessage(msg) {
                log.textContent += msg + '\n';
            }

            const testDate = document.getElementById('testDate').value;
            logMessage(`ğŸ“… ç”Ÿæˆ ${testDate} çš„æ—¥æŠ¥...`);
            
            // è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„æ—¥æŠ¥ç”Ÿæˆé€»è¾‘
            logMessage('åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·åœ¨ä¸»é¡µé¢æµ‹è¯•å®Œæ•´åŠŸèƒ½');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿä»»åŠ¡
        window.onload = function() {
            displayMockTasks();
        };
    </script>
</body>
</html>
